---
name: qscmf-backend
description: |
  QSCMF framework (ThinkPHP 3.2 + Laravel hybrid) backend development and code generation.

  **Auto-detects QSCMF projects**: Contains app/ + lara/ directories, Gy_Library, AntdAdmin components.

  **Scaffold Mode** (åœ¨ QSCMF é¡¹ç›®ä¸­è‡ªåŠ¨è§¦å‘, or å¼ºåˆ¶è§¦å‘ with "QSCMF"):
  - "åˆ›å»º Product æ¨¡å—" â†’ Generate CRUD module (in QSCMF project context)
  - "ç”Ÿæˆ User API" â†’ Generate RESTful API (in QSCMF project context)
  - "QSCMF scaffold Order" â†’ Force trigger scaffold mode
  - "åˆ›å»º QSCMF CRUD for Article" â†’ Explicit framework reference

  **Guide Mode** (QSCMF å¼€å‘é—®é¢˜):
  - "å¦‚ä½•å®ç° QsListController CRUD?" - Admin development
  - "AntdAdmin Table ç»„ä»¶å¦‚ä½•ä½¿ç”¨?" - UI components
  - "å¦‚ä½•ç¼–å†™ PHPUnit æµ‹è¯•?" - Testing patterns
  - "GyListModel éªŒè¯è§„åˆ™?" - Model development

  **When to use**: Any QSCMF backend development (CRUD, API, tests, migrations) in projects with QSCMF structure.
---

# QSCMF Backend Development

## Mode Selection

This skill operates in two modes based on user request:

### Scaffold Mode (Code Generation)

Triggers: "åˆ›å»º", "ç”Ÿæˆ", "scaffold", "æ¨¡å—", "CRUD", "API"

**Quick Start**:
```markdown
User: åˆ›å»º Product æ¨¡å—ï¼Œéœ€è¦åå° CRUD å’Œ API

AI Workflow:
  1. Identify: Module=Product, Requirements=CRUD+API
  2. Parse schema from migration or database
  3. Infer field types using three-layer strategy
  4. Generate code from templates
  5. Write files to project directories
  6. Output TODO list for manual steps
```

See [Scaffold Workflow](#scaffold-workflow) below.

### Guide Mode (Development Guide)

Default mode for QSCMF development questions.

**Quick Start**:
```markdown
User: å¦‚ä½•å®ç° QsListController çš„ CRUDï¼Ÿ
User: AntdAdmin Table ç»„ä»¶å¦‚ä½•ä½¿ç”¨ï¼Ÿ
User: å¦‚ä½•ç¼–å†™ PHPUnit æµ‹è¯•ï¼Ÿ
```

See [Framework Guide](#framework-guide) below.

---

## Scaffold Workflow

### Step 1: Identify Requirements

Extract from user request:
- **Module name**: Product, User, Order, etc.
- **Components needed**:
  - Model? (GyListModel)
  - AdminController? (QsListController + AntdAdmin)
  - ApiController? (RestController)
  - Migration? (Laravel Schema)
  - Test? (PHPUnit)

### Step 2: Parse Table Schema

**Option A**: From Migration (preferred)
```bash
# Find migration file
ls lara/database/migrations/*create_product*
```

**Option B**: Using script
```bash
php scripts/parse_schema.php qs_product
```

Output:
```json
{
  "table": "qs_product",
  "fields": [
    {"name": "product_name", "type": "varchar(200)", "comment": "@title=äº§å“åç§°;@type=text"},
    {"name": "cover", "type": "int", "comment": "@title=å°é¢å›¾;@type=image"},
    {"name": "status", "type": "tinyint", "comment": "@title=çŠ¶æ€;@type=select"}
  ]
}
```

### Step 3: Infer Field Types

Use three-layer inference:

**Layer 1**: Configuration
```yaml
# .claude/qscmf/field-rules.yaml
product_content: ueditor
*_date: date
status: select
cover: image
```

**Layer 2**: Learning from code
```bash
php scripts/infer_types.php --scan app/Admin/Controller/
```

**Layer 3**: Default rules
```php
// Field name suffix patterns
*_content â†’ ueditor
*_date â†’ date
*_time â†’ time
*_id â†’ select/foreign
status â†’ select
cover â†’ image
file_id â†’ file
sort â†’ number
```

### Step 4: Generate Code

Use templates from `assets/templates/`:

**Model Template** â†’ `model.php.tpl`
```php
class {{MODEL_NAME}}Model extends GyListModel
{
    protected $_validate = [
{{VALIDATE_RULES}}
    ];
}
```

**AdminController Template** â†’ `admin_controller.php.tpl`
```php
class {{MODEL}}Controller extends QsListController
{
    public function index() {
        $table = new Table();
{{TABLE_COLUMNS}}
        return $table->render();
    }

    protected function buildTableColumns($container) {
        $container->text('{{FIELD_NAME}}', '{{FIELD_TITLE}}');
    }
}
```

**ApiController Template** â†’ `api_controller.php.tpl`
```php
class {{MODEL}}Controller extends RestController
{
    public function gets(): Response {
        // ...
    }
}
```

### Step 5: Write Files

Rules:
- âœ… Create new files
- âŒ Skip existing files (unless --force confirmed)
- ğŸ“ Maintain proper directory structure

File paths:
```
Model:          app/Common/Model/{{MODEL}}Model.class.php
AdminController: app/Admin/Controller/{{MODEL}}Controller.class.php
ApiController:  app/Api/Controller/{{MODEL}}Controller.class.php
Migration:      lara/database/migrations/xxxx_create_{{table}}_table.php
Test:           lara/tests/Feature/{{MODEL}}Test.php
```

### Step 6: Output TODO List

```markdown
âœ… Generated files:
  - app/Common/Model/ProductModel.class.php
  - app/Admin/Controller/ProductController.class.php
  - app/Api/Controller/ProductController.class.php

ğŸ“ TODO (manual):
  - [ ] Run migration: php artisan migrate
  - [ ] Configure permissions in qs_node table
  - [ ] Add validation rules in Model::$_validate
  - [ ] Implement business logic (save, delete hooks)
  - [ ] Add foreign key relationships
  - [ ] Run tests: vendor/bin/phpunit

ğŸ“š References:
  - Admin Controllers: references/admin-controllers.md
  - Testing Guide: references/development-standards.md
```

---

## Framework Guide

### Quick Reference

#### Standard CRUD Module

```php
// 1. Migration (lara/database/migrations/)
Schema::create('qs_demo', function (Blueprint $table) {
    $table->id();
    $table->string('title', 200)->comment('æ ‡é¢˜');
    $table->text('content')->nullable()->comment('å†…å®¹');
    $table->tinyInteger('status')->default(1)->comment('çŠ¶æ€');
    $table->timestamps();
});

// 2. Model (app/Common/Model/)
class DemoModel extends GyListModel
{
    protected $_validate = [
        ['title', 'require', 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º', self::MUST_VALIDATE],
    ];
}

// 3. Controller (app/Admin/Controller/)
class DemoController extends QsListController
{
    // See references/admin-controllers.md for full code
}
```

#### RESTful API

```php
namespace Api\Controller;

use Qscmf\Api\RestController;
use QscmfApiCommon\Cache\Response;

class DemoController extends RestController
{
    protected $noAuthorization = ['gets', 'detail'];

    public function gets(): Response
    {
        $get_data = I('get.');
        // ...
        return new Response('æˆåŠŸ', 1, $data);
    }
}
```

See [API Controllers](references/api-controllers.md).

#### Unit Testing

```php
namespace Lara\Tests\Feature;

use Lara\Tests\TestCase;

class DemoTest extends TestCase
{
    public function testGetList(): void
    {
        $response = $this->get('/api.php/Demo/gets');
        $response->assertStatus(200)->assertJson(['status' => 1]);
    }

    public function testWithMock(): void
    {
        $mock = $this->createMock(ApiService::class);
        $mock->method('fetch')->willReturn(['success' => true]);
        app()->instance(ApiService::class, $mock);

        $result = D('Demo')->processData(123);
        $this->assertTrue($result);
    }
}
```

See [Development Standards](references/development-standards.md).

---

### Common Code Patterns

#### AntdAdmin Components

**Table åˆ—ç±»å‹**:
```php
// åŸºç¡€åˆ—ç±»å‹
$container->text('title', 'æ ‡é¢˜');
$container->textarea('content', 'å†…å®¹');
$container->select('status', 'çŠ¶æ€')->setValueEnum(DBCont::getStatusList());
$container->date('create_time', 'åˆ›å»ºæ—¶é—´')->setSearch(false);
$container->datetime('update_time', 'æ›´æ–°æ—¶é—´');
$container->number('price', 'ä»·æ ¼');
$container->image('cover', 'å°é¢å›¾');
$container->images('gallery', 'å›¾ç‰‡é›†');
$container->file('attachment', 'é™„ä»¶');
$container->link('url', 'é“¾æ¥');
$container->tags('tags', 'æ ‡ç­¾');
$container->boolean('is_active', 'æ˜¯å¦æ¿€æ´»');
$container->progress('progress', 'è¿›åº¦');

// åˆ—é…ç½®æ–¹æ³•
->setSearch(true)              // æ˜¾ç¤ºæœç´¢æ¡†
->setSearch(false)             // éšè—æœç´¢æ¡†
->setSortable(true)            // å…è®¸æ’åº
->setSortable(false)           // ç¦æ­¢æ’åº
->editable()                   // è¡Œå†…ç¼–è¾‘
->setWidth(200)                // è®¾ç½®åˆ—å®½
->setShowCondition('status', 'eq', 1)  // æ¡ä»¶æ˜¾ç¤º
->setValueEnum([1=>'å¯ç”¨', 0=>'ç¦ç”¨'])  // æšä¸¾å€¼
->setRender(function($value, $row) {    // è‡ªå®šä¹‰æ¸²æŸ“
    return "<a href='{$value}'>é“¾æ¥</a>";
})
```

**Form è¡¨å•å­—æ®µç±»å‹**:
```php
// åŸºç¡€å­—æ®µ
$columns->text('title', 'æ ‡é¢˜');
$columns->textarea('summary', 'æ‘˜è¦');
$columns->number('sort', 'æ’åº');
$columns->price('price', 'ä»·æ ¼');
$columns->select('status', 'çŠ¶æ€')->setValueEnum(DBCont::getStatusList());
$columns->radio('type', 'ç±»å‹')->setValueEnum([1=>'ç±»å‹A', 2=>'ç±»å‹B']);
$columns->checkbox('tags', 'æ ‡ç­¾')->setValueEnum(['tag1', 'tag2', 'tag3']);
$columns->date('publish_date', 'å‘å¸ƒæ—¥æœŸ');
$columns->datetime('create_time', 'åˆ›å»ºæ—¶é—´');
$columns->time('open_time', 'å¼€æ”¾æ—¶é—´');
$columns->color('theme_color', 'ä¸»é¢˜è‰²');

// æ–‡ä»¶ä¸Šä¼ å­—æ®µ
$columns->image('cover_id', 'å°é¢å›¾')
    ->setUploadRequest(FormItem\ObjectStorage\Lib\Common::genItemDataUrl('image'))
    ->setCrop('866/490');  // è£å‰ªæ¯”ä¾‹

$columns->images('gallery_ids', 'å›¾ç‰‡é›†')
    ->setUploadRequest(FormItem\ObjectStorage\Lib\Common::genItemDataUrl('image'))
    ->setLimit(9);  // æœ€å¤š9å¼ 

$columns->file('file_id', 'é™„ä»¶')
    ->setUploadRequest(FormItem\ObjectStorage\Lib\Common::genItemDataUrl('file'))
    ->setFileExt(['pdf', 'doc', 'docx', 'xls', 'xlsx']);

$columns->ueditor('content', 'è¯¦æƒ…å†…å®¹')->setFormItemWidth(24);

// å…³è”å­—æ®µ
$columns->select('cate_id', 'åˆ†ç±»')
    ->setValueEnum(D('Cate')->getField('id,name'))
    ->addRule(new Required());

$columns->select('user_id', 'ç”¨æˆ·')
    ->setSelectOptions(\Qscmf\Lib\DBCont::getUserOptions());

// å­—æ®µé…ç½®æ–¹æ³•
->addRule(new Required())      // å¿…å¡«
->setFormItemWidth(24)         // è¡¨å•å®½åº¦ (24=100%, 12=50%)
->setPlaceholder('è¯·è¾“å…¥...')   // å ä½ç¬¦
->setHelp('å¸®åŠ©æç¤ºæ–‡æœ¬')      // å¸®åŠ©æ–‡æœ¬
->setDefaultValue(1)           // é»˜è®¤å€¼
->setDisabled(true)            // ç¦ç”¨
->setReadOnly(true)            // åªè¯»
->setFormItemColNumber(12)     // æ …æ ¼åˆ—æ•°
```

**Modal å¼¹çª—æ¨¡å¼**:
```php
// ç¼–è¾‘å¼¹çª—
$actions->edit()->modal(
    (new \AntdAdmin\Component\Modal\Modal())
        ->setTitle('ç¼–è¾‘ç”¨æˆ·')
        ->setWidth(800)
        ->setForm($this->buildEditFormColumns(...))
);

// è‡ªå®šä¹‰å¼¹çª—
$actions->custom('è‡ªå®šä¹‰æ“ä½œ')->modal(
    (new \AntdAdmin\Component\Modal\Modal())
        ->setTitle('è‡ªå®šä¹‰æ“ä½œ')
        ->setTemplate('<div>è‡ªå®šä¹‰å†…å®¹</div>')
);
```

#### Table Columns (ListBuilder æ—§ç‰ˆå…¼å®¹)

```php
// é€‚ç”¨äºæ—§ç‰ˆ ListBuilder
$builder = new \Qscmf\Builder\ListBuilder();

$builder->setMetaTitle('ç”¨æˆ·åˆ—è¡¨')
        ->addTopButton('addnew')
        ->addTopButton('forbid')
        ->addTopButton('resume')

        // æœç´¢é¡¹
        ->addSearchItem('keyword', 'text', 'æœç´¢')
        ->addSearchItem('status', 'select', 'çŠ¶æ€', '', DBCont::getStatusList())

        // è¡¨æ ¼åˆ—
        ->addTableColumn('id', 'ID')
        ->addTableColumn('nick_name', 'ç”¨æˆ·å')
        ->addTableColumn('email', 'é‚®ç®±')
        ->addTableColumn('status', 'çŠ¶æ€', DBCont::getStatusList())

        // æ“ä½œæŒ‰é’®
        ->addRightButton('edit')
        ->addRightButton('delete')

        ->build();
```

#### Form Fields (FormBuilder æ—§ç‰ˆå…¼å®¹)

```php
$builder = new \Qscmf\Builder\FormBuilder();

$builder->setMetaTitle('æ–°å¢ç”¨æˆ·')
        ->addFormItem('nick_name', 'text', 'ç”¨æˆ·å*', '', '', '', 'required')
        ->addFormItem('email', 'text', 'é‚®ç®±*')
        ->addFormItem('telephone', 'text', 'æ‰‹æœºå·')
        ->addFormItem('pwd', 'password', 'å¯†ç ')
        ->addFormItem('role', 'select', 'ç”¨æˆ·ç»„', '', $role_options)
        ->addFormItem('avatar', 'image', 'å¤´åƒ')
        ->addFormItem('status', 'radio', 'çŠ¶æ€', '', DBCont::getStatusList())
        ->build();
```

#### Form Fields

```php
$columns->text('title', 'æ ‡é¢˜')
    ->addRule(new Required())
    ->setFormItemWidth(24);

$columns->image('cover_id', 'å°é¢å›¾')
    ->setUploadRequest(FormItem\ObjectStorage\Lib\Common::genItemDataUrl('image'))
    ->setCrop('866/490');

$columns->ueditor('content', 'è¯¦æƒ…å†…å®¹')->setFormItemWidth(24);

$columns->select('cate_id', 'åˆ†ç±»')
    ->setValueEnum(D('Cate')->getField('id,name'))
    ->addRule(new Required());
```

#### Database Constants

```php
use Gy_Library\DBCont;

DBCont::NORMAL_STATUS      // = 1 (å¯ç”¨)
DBCont::DISABLE_STATUS     // = 0 (ç¦ç”¨)
DBCont::AUDIT_STATUS       // = 2 (å¾…å®¡æ ¸)

\Qscmf\Lib\DBCont::getStatusList()    // [1 => 'å¯ç”¨', 0 => 'ç¦ç”¨']
```

#### PHP 8.2 Best Practices

```php
// âœ… Type declarations
public function getUserById(int $id): ?array
{
    return $this->where(['id' => $id])->find();
}

// âœ… Strict comparison
if ($status === DBCont::NORMAL_STATUS) { }

// âœ… Arrow functions
$ids = array_map(fn($item) => (int)$item['id'], $list);

// âœ… Match expressions
$type = match($field) {
    'content' => 'ueditor',
    'status' => 'select',
    default => 'text'
};
```

#### Search Condition Building

```php
// å¤šå­—æ®µæ¨¡ç³Šæœç´¢
$keyword = I('keyword', '', 'string');
$map['id|nick_name|email|telephone'] = array('like', '%' . $keyword . '%', '_multi' => true);

// çŠ¶æ€ç­›é€‰
$status = I('status', -1, 'int');
if ($status !== -1) {
    $map['status'] = $status;
}

// æ—¥æœŸèŒƒå›´
$startDate = I('start_date', '');
$endDate = I('end_date', '');
if ($startDate && $endDate) {
    $map['create_time'] = array('between', [$startDate, $endDate]);
}

// ç»„åˆæŸ¥è¯¢ç¤ºä¾‹
public function index($status = DBCont::NORMAL_STATUS) {
    $map = $this->buildSearchMap();

    $list = D('User')
        ->where($map)
        ->order('id desc')
        ->select();

    $this->assign('list', $list);
    $this->display();
}

protected function buildSearchMap(): array {
    $map = [];

    // å…³é”®è¯æœç´¢
    $keyword = I('keyword', '');
    if ($keyword) {
        $map['id|nick_name|email'] = array('like', '%' . $keyword . '%', '_multi' => true);
    }

    // çŠ¶æ€ç­›é€‰
    $status = I('status', -1, 'int');
    if ($status !== -1) {
        $map['status'] = $status;
    }

    // æ—¶é—´èŒƒå›´
    $startTime = I('start_time', '');
    $endTime = I('end_time', '');
    if ($startTime && $endTime) {
        $map['create_time'] = ['between', [$startTime, $endTime]];
    }

    return $map;
}
```

#### CLI Controller Pattern

```php
if (!IS_CLI) die('The file can only be run in cli mode!');

class SyncController extends CliModeHelperController
{
    private const BATCH_SIZE = 50;

    public function __construct()
    {
        parent::__construct('sync_log');
    }

    public function run()
    {
        try {
            $stats = $this->processBatch();
            $this->printStats($stats);
            return 0;
        } catch (\Exception $e) {
            $this->writeErrorLog('[ERROR] ' . $e->getMessage(), true);
            return 1;
        }
    }

    private function processBatch(): array
    {
        $stats = ['success' => 0, 'failed' => 0, 'total' => 0];
        $pages = ceil($total / self::BATCH_SIZE);

        for ($page = 1; $page <= $pages; $page++) {
            $list = D('Model')->limit(self::BATCH_SIZE)->page($page)->select();
            foreach ($list as $item) {
                $result = $this->processOne($item);
                $stats[$result['status']]++;
            }
            if ($page < $pages) sleep(1);
        }
        return $stats;
    }

    private function printStats(array $stats): void
    {
        $this->writeErrorLog("æˆåŠŸ: {$stats['success']}, å¤±è´¥: {$stats['failed']}", true);
    }
}
```

**Key Points:**
- âœ… å¼ºåˆ¶ CLI æ¨¡å¼æ£€æŸ¥
- âœ… ç»§æ‰¿ `CliModeHelperController`
- âœ… åˆ†æ‰¹å¤„ç†é¿å…å†…å­˜æº¢å‡º
- âœ… è¿”å› 0/1 è¡¨ç¤ºæ‰§è¡Œç»“æœ

---

## Advanced Patterns

### Redis Lock Pattern

```php
use Gy_Library\RedisLock;

// é˜²æ­¢å¹¶å‘æ‰§è¡Œ
public function save($id = null) {
    $lock_key = 'product_save_' . ($id ?? 'new');

    $lock = new RedisLock($lock_key, 10); // 10ç§’è¶…æ—¶

    if (!$lock->acquire()) {
        $this->error('æ“ä½œé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
    }

    try {
        // ä¸šåŠ¡é€»è¾‘
        $result = parent::save($id);

        $lock->release();
        return $result;
    } catch (\Exception $e) {
        $lock->release();
        throw $e;
    }
}
```

### Knowledge Store Sync Pattern

```php
// åœ¨çŸ¥è¯†åº“åŒæ­¥ä¸­ä½¿ç”¨
use Qscmf\Builder\FormBuilder;

public function add() {
    $form = new FormBuilder();

    $form->addFormItem('title', 'text', 'æ ‡é¢˜')
         ->addFormItem('content', 'ueditor', 'å†…å®¹')

         // çŸ¥è¯†åº“å­—æ®µé…ç½®
         ->setKnowledgeStoreField('content', [
             'title_field' => 'title',
             'content_field' => 'content',
             'category' => 'product',
             'tags' => ['äº§å“', 'ä»‹ç»']
         ])
         ->build();

    $this->display($form);
}
```

### Wall Class Pattern (External API)

```php
namespace App\Wall;

use Gy_Library\RedisLock;

class ExternalApiWall
{
    private string $baseUrl;
    private string $apiKey;
    private ?RedisLock $lock = null;

    public function __construct(string $baseUrl, string $apiKey)
    {
        $this->baseUrl = rtrim($baseUrl, '/');
        $this->apiKey = $apiKey;
    }

    /**
     * è°ƒç”¨å¤–éƒ¨API
     */
    public function call(string $endpoint, array $data = [], string $method = 'GET'): array
    {
        $url = $this->baseUrl . '/' . ltrim($endpoint, '/');
        $lockKey = md5($url . serialize($data));

        // ä½¿ç”¨Redisé”é˜²æ­¢å¹¶å‘è¯·æ±‚
        $this->lock = new RedisLock('api_call_' . $lockKey, 5);
        $this->lock->acquire();

        try {
            if ($method === 'GET') {
                $response = (new \Gy_Library\GyHttpClient())->get($url, [
                    'query' => $data,
                    'headers' => ['Authorization' => 'Bearer ' . $this->apiKey]
                ]);
            } else {
                $response = (new \Gy_Library\GyHttpClient())->post($url, [
                    'json' => $data,
                    'headers' => ['Authorization' => 'Bearer ' . $this->apiKey]
                ]);
            }

            return $this->parseResponse($response);
        } finally {
            $this->lock->release();
        }
    }

    private function parseResponse(array $response): array
    {
        if ($response['code'] !== 200) {
            throw new \Exception('APIè°ƒç”¨å¤±è´¥: ' . ($response['message'] ?? 'Unknown error'));
        }

        return $response['data'] ?? [];
    }

    /**
     * Mockæ¥å£ï¼ˆç”¨äºæµ‹è¯•ï¼‰
     */
    public static function mock(array $responseData): self
    {
        return new class($responseData) extends ExternalApiWall {
            private array $data;

            public function __construct(array $data)
            {
                parent::__construct('mock://', '');
                $this->data = $data;
            }

            public function call(string $endpoint, array $data = [], string $method = 'GET'): array
            {
                return $this->data;
            }
        };
    }
}

// ä½¿ç”¨ç¤ºä¾‹
$api = new ExternalApiWall('https://api.example.com', 'your-api-key');
$result = $api->call('/v1/users', ['page' => 1], 'GET');
```

### Queue Job Pattern

```php
// åˆ›å»ºé˜Ÿåˆ—Job
namespace Lara\App\Jobs;

use Qscmf\Queue\QueueJob;

class SyncProductJob extends QueueJob
{
    private int $productId;

    public function __construct(int $productId)
    {
        $this->productId = $productId;
        $this->queue = 'product_sync';  // é˜Ÿåˆ—åç§°
    }

    public function handle(): bool
    {
        $product = D('Product')->find($this->productId);

        if (!$product) {
            return false;
        }

        // åŒæ­¥åˆ°ç¬¬ä¸‰æ–¹å¹³å°
        $result = D('Sync')->syncProduct($product);

        if ($result) {
            D('Product')->save([
                'id' => $this->productId,
                'sync_status' => 1,
                'sync_time' => time()
            ]);
        }

        return $result;
    }
}

// æ¨é€ä»»åŠ¡åˆ°é˜Ÿåˆ—
\Qscmf\Queue\Queue::push(
    \Lara\App\Jobs\SyncProductJob::class,
    ['productId' => $productId],
    'product_sync'
);
```

### File Upload Pattern

```php
namespace Api\Controller;

use Think\Controller;

class UploadController extends Controller
{
    // ä¸Šä¼ å‰é…ç½®æ¥å£
    public function upload() {
        $get_data = I('get.');
        $this->checkRequired($get_data, ['title', 'cate']);

        // æ„å»ºä¸Šä¼ é…ç½®
        $upload_config = [
            'title' => $get_data['title'],
            'cate' => $get_data['cate'],
            'file_ext' => $get_data['file_ext'] ?? 'jpg,png,gif,jpeg',
            'file_size' => $get_data['file_size'] ?? 10 * 1024 * 1024, // 10MB
        ];

        $return_params = [
            'title' => $upload_config['title'],
            'cate' => $upload_config['cate'],
        ];

        $ajax = [
            'status' => 0,
            'server_url' => U("uploadFile", $return_params, false, true)
        ];

        $this->ajaxReturn($ajax);
    }

    // æ–‡ä»¶ä¸Šä¼ æ¥å£
    public function uploadFile() {
        $title = I('get.title', '');
        $cate = I('get.cate', '');

        $upload_config = [
            'save_path' => 'Uploads/' . $cate . '/' . date('Ymd') . '/',
            'save_name' => ['uniqid', ''],
            'exts' => ['jpg', 'png', 'gif', 'jpeg'],
            'max_size' => 10 * 1024 * 1024, // 10MB
            'sub_name' => ['date', 'Ymd'],
        ];

        $upload = new \Think\Upload($upload_config);
        $info = $upload->uploadOne($_FILES['file']);

        if (!$info) {
            $this->ajaxReturn([
                'status' => 1,
                'message' => $upload->getError()
            ]);
        }

        // ä¿å­˜åˆ°é™„ä»¶è¡¨
        $file_id = D('File')->add([
            'title' => $title,
            'file_path' => $info['savepath'] . $info['savename'],
            'file_size' => $info['size'],
            'file_ext' => $info['ext'],
            'cate' => $cate,
            'create_time' => time()
        ]);

        $this->ajaxReturn([
            'status' => 0,
            'message' => 'ä¸Šä¼ æˆåŠŸ',
            'data' => [
                'file_id' => $file_id,
                'url' => $info['savepath'] . $info['savename']
            ]
        ]);
    }

    // å¿…å¡«å‚æ•°æ£€æŸ¥
    protected function checkRequired(array $data, array $fields): void
    {
        foreach ($fields as $field) {
            if (empty($data[$field])) {
                $this->ajaxReturn([
                    'status' => 1,
                    'message' => "å‚æ•° {$field} ä¸èƒ½ä¸ºç©º"
                ]);
            }
        }
    }
}
```

---

## Architecture Overview

### Directory Structure

```
project_root/
â”œâ”€â”€ app/                    # ThinkPHP åº”ç”¨å±‚
â”‚   â”œâ”€â”€ Admin/             # åå°æ¨¡å— (ç®¡ç†ç•Œé¢)
â”‚   â”‚   â”œâ”€â”€ Controller/    # åå°æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Conf/          # åå°é…ç½®
â”‚   â”‚   â””â”€â”€ View/          # åå°è§†å›¾
â”‚   â”œâ”€â”€ Home/              # å‰å°æ¨¡å—
â”‚   â”œâ”€â”€ Api/               # APIæ¨¡å— (RESTfulæ¥å£)
â”‚   â”‚   â””â”€â”€ Controller/    # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ Common/            # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ Model/         # æ¨¡å‹å±‚ (GyListModel)
â”‚   â”‚   â”œâ”€â”€ Conf/          # å…¬å…±é…ç½®
â”‚   â”‚   â””â”€â”€ Common.php     # å…¬å…±å‡½æ•°
â”‚   â”œâ”€â”€ Gy_Library/        # æ ¸å¿ƒæ‰©å±•åº“
â”‚   â”‚   â”œâ”€â”€ GyListModel.php       # åŸºç¡€æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ GyListController.php  # åŸºç¡€æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ DBCont.php            # æ•°æ®åº“å¸¸é‡
â”‚   â”‚   â”œâ”€â”€ RedisLock.php         # Redisé”
â”‚   â”‚   â””â”€â”€ CliModeHelperController.php  # CLIè¾…åŠ©
â”‚   â”œâ”€â”€ Addons/            # æ’ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ Behaviors/         # è¡Œä¸ºæ‰©å±•
â”‚   â”œâ”€â”€ Runtime/           # è¿è¡Œæ—¶ç¼“å­˜
â”‚   â”œâ”€â”€ Tpl/               # æ¨¡æ¿ç›®å½•
â”‚   â””â”€â”€ Uploads/           # ä¸Šä¼ ç›®å½•
â”œâ”€â”€ lara/                  # Laravel é›†æˆå±‚
â”‚   â”œâ”€â”€ app/               # Laravelåº”ç”¨
â”‚   â”œâ”€â”€ config/            # Laravelé…ç½®
â”‚   â”œâ”€â”€ database/          # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â””â”€â”€ migrations/    # Schemaæ–‡ä»¶
â”‚   â””â”€â”€ tests/             # PHPUnitæµ‹è¯•
â”‚       â”œâ”€â”€ Feature/       # åŠŸèƒ½æµ‹è¯•
â”‚       â”œâ”€â”€ Browser/       # æµè§ˆå™¨æµ‹è¯•
â”‚       â””â”€â”€ TestCase.php   # æµ‹è¯•åŸºç±»
â”œâ”€â”€ www/                   # Webå…¥å£ç›®å½•
â”‚   â””â”€â”€ index.php          # ä¸»å…¥å£
â”œâ”€â”€ vendor/                # Composerä¾èµ–
â”‚   â””â”€â”€ quansitech/        # QSCMFæ ¸å¿ƒåŒ…
â”‚       â”œâ”€â”€ qscmf/         # æ¡†æ¶æ ¸å¿ƒ
â”‚       â””â”€â”€ antd-admin/   # AntdAdminç»„ä»¶åº“
â””â”€â”€ resources/             # å‰ç«¯èµ„æº
```

### Hybrid Framework

**ThinkPHP Layer** (`app/`):
- ä¸šåŠ¡é€»è¾‘å±‚ã€æ§åˆ¶å™¨ã€æ¨¡å‹
- ä½¿ç”¨ `D('ModelName')` è°ƒç”¨æ¨¡å‹
- ä½¿ç”¨ `M()` è¿›è¡ŒåŸå§‹è¡¨æ“ä½œ
- è·¯ç”±æ ¼å¼ï¼š`/module/controller/action`

**Laravel Layer** (`lara/`):
- æ•°æ®åº“è¿ç§» (Schema Builder)
- ä¾èµ–æ³¨å…¥å®¹å™¨
- PHPUnit æµ‹è¯•æ¡†æ¶
- é˜Ÿåˆ—ç³»ç»Ÿ (Redisé©±åŠ¨)

### Core Components

| Component | Base Class | Location | Purpose |
|-----------|-----------|----------|---------|
| Admin Controller | `QsListController` | `app/Admin/Controller/` | CRUDç®¡ç†ç•Œé¢ |
| API Controller | `RestController` | `app/Api/Controller/` | RESTful API |
| Model | `GyListModel` | `app/Common/Model/` | æ•°æ®è®¿é—®å±‚ |
| CLI Controller | `CliModeHelperController` | Any module | å‘½ä»¤è¡Œä»»åŠ¡ |
| Queue Job | | `lara/app/Jobs/` | å¼‚æ­¥ä»»åŠ¡ |

### Framework Features

**RBAC æƒé™ç³»ç»Ÿ**:
```php
// èŠ‚ç‚¹æƒé™è¡¨ç»“æ„
qs_node          # æƒé™èŠ‚ç‚¹
qs_role_user     # ç”¨æˆ·è§’è‰²å…³è”
qs_access        # è§’è‰²æƒé™å…³è”

// æƒé™æ£€æŸ¥èŠ‚ç‚¹æ ¼å¼
Admin/User/index       # ç”¨æˆ·åˆ—è¡¨
Admin/User/add         # æ–°å¢ç”¨æˆ·
Admin/User/save        # ä¿å­˜ç”¨æˆ·
```

**æ’ä»¶ç³»ç»Ÿ**:
```php
// æ’ä»¶ç›®å½•ç»“æ„
Addons/
â”œâ”€â”€ PluginName/
â”‚   â”œâ”€â”€ PluginName.class.php    # æ’ä»¶å…¥å£
â”‚   â”œâ”€â”€ controller/             # æ’ä»¶æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ model/                  # æ’ä»¶æ¨¡å‹
â”‚   â””â”€â”€ config.php              # æ’ä»¶é…ç½®

// æ’ä»¶è°ƒç”¨
D('Addons')->addonExecute('PluginName', 'action', $params);
```

**é˜Ÿåˆ—ç³»ç»Ÿ**:
```bash
# å¯åŠ¨é˜Ÿåˆ—Worker
QUEUE_ENV=prod QUEUE_COUNT=1 php app/queue_resque.php

# æ¨é€ä»»åŠ¡åˆ°é˜Ÿåˆ—
\Qscmf\Queue\Queue::push($job_class, $args, $queue_name);
```

### Development Mode Decision Tree

```
What feature do you need?
â”‚
â”œâ”€ Admin CRUD
â”‚  â”œâ”€ Simple CRUD? â†’ Standard CRUD (QsListController + AntdAdmin)
â”‚  â””â”€ Multiple similar modules? â†’ Abstract Base pattern
â”‚
â”œâ”€ RESTful API
â”‚  â””â”€ API Controller pattern (RestController)
â”‚
â”œâ”€ Complex Business Logic
â”‚  â”œâ”€ Batch operations? â†’ Custom controller + RedisLock
â”‚  â”œâ”€ Async tasks? â†’ Queue + Job
â”‚  â””â”€ External API? â†’ Wall class + Mock testing
â”‚
â””â”€ Frontend Page
   â””â”€ HomeController + Inertia.js + React/TS
```

---

## Common Commands

```bash
# Database
php artisan make:migration create_table_name
php artisan migrate
php artisan migrate:rollback
php artisan migrate:fresh --seed

# ThinkPHP CLI
php www/index.php <module>/<controller>/<action>
php www/index.php Admin/User/index

# Testing
vendor/bin/phpunit                           # è¿è¡Œæ‰€æœ‰æµ‹è¯•
vendor/bin/phpunit tests/Feature/UserTest    # è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
vendor/bin/phpunit --filter testAdd         # è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•

# Queue
QUEUE_ENV=prod QUEUE_COUNT=1 php app/queue_resque.php

# Cache
php think clear --cache                      # æ¸…é™¤ç¼“å­˜
php think clear --temp                       # æ¸…é™¤ä¸´æ—¶æ–‡ä»¶

# Database Schema
php artisan schema:dump                      # å¯¼å‡ºæ•°æ®åº“ç»“æ„
```

## Best Practices Summary

### 1. Security

```php
// âœ… ä½¿ç”¨ I() å‡½æ•°è¿‡æ»¤è¾“å…¥
$keyword = I('keyword', '', 'string');
$id = I('get.id', 0, 'int');

// âœ… SQLæ³¨å…¥é˜²æŠ¤ - ä½¿ç”¨å‚æ•°ç»‘å®š
$result = D('User')->where(['id' => $id])->find();

// âœ… XSSé˜²æŠ¤ - è¾“å‡ºæ—¶è½¬ä¹‰
{$vo.title|htmlspecialchars}

// âœ… CSRFé˜²æŠ¤ - è¡¨å•Token
<input type="hidden" name="__hash__" value="{:session('__HASH__')}">

// âŒ é¿å…ç›´æ¥æ‹¼æ¥SQL
$sql = "SELECT * FROM user WHERE id = $id";  // å±é™©ï¼
```

### 2. Performance

```php
// âœ… æ‰¹é‡æ“ä½œ
foreach ($chunks as $chunk) {
    D('User')->addAll($chunk);
}

// âœ… ä½¿ç”¨ç¼“å­˜
S('cache_key', $data, 3600);  // ç¼“å­˜1å°æ—¶
$data = S('cache_key');        // è¯»å–ç¼“å­˜

// âœ… é¿å…N+1æŸ¥è¯¢
$list = D('Product')
    ->join('LEFT JOIN qs_cate ON qs_product.cate_id = qs_cate.id')
    ->field('qs_product.*, qs_cate.name as cate_name')
    ->select();

// âœ… åˆ†é¡µ
$Page = new \Think\Page($total, 20);
$show = $Page->show();
$list = D('User')->limit($Page->firstRow . ',' . $Page->listRows)->select();
```

### 3. Error Handling

```php
// âœ… ä½¿ç”¨try-catch
try {
    $result = D('User')->save($data);
} catch (\Exception $e) {
    E('æ“ä½œå¤±è´¥: ' . $e->getMessage());
}

// âœ… æ—¥å¿—è®°å½•
\Think\Log::record('é”™è¯¯ä¿¡æ¯', 'ERR');
\Think\Log::record('è°ƒè¯•ä¿¡æ¯', 'DEBUG');

// âœ… è¿”å›æ ‡å‡†é”™è¯¯æ ¼å¼
$this->ajaxReturn([
    'status' => 1,
    'message' => 'æ“ä½œå¤±è´¥',
    'data' => []
]);
```

### 4. Code Organization

```php
// âœ… æ¨¡å‹å°è£…ä¸šåŠ¡é€»è¾‘
class UserModel extends GyListModel
{
    // è·å–ç”¨æˆ·è§’è‰²
    public function getUserRole(int $userId): array
    {
        return $this->join('__ROLE_USER__ ON __USER__.id = __ROLE_USER__.user_id')
            ->join('__ROLE__ ON __ROLE_USER__.role_id = __ROLE__.id')
            ->where(['qs_user.id' => $userId])
            ->field('qs_role.*')
            ->select();
    }

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    public function isNickNameExists(string $nickName, int $excludeId = 0): bool
    {
        $map = ['nick_name' => $nickName];
        if ($excludeId > 0) {
            $map['id'] = ['neq', $excludeId];
        }
        return (bool)$this->where($map)->count();
    }
}
```

### 5. Configuration

```php
// âœ… ç¯å¢ƒå˜é‡ä½¿ç”¨
$dbHost = env('DB_HOST', 'localhost');
$dbPort = env('DB_PORT', 3306);

// âœ… é…ç½®æ–‡ä»¶è¯»å–
$uploadConfig = C('UPLOAD_CONFIG_QINIU');
$maxSize = C('UPLOAD_MAX_SIZE');

// âœ… æ¨¡å—é…ç½®
$moduleConfig = C('MODULE_ALIAS');
```

## Debugging Tips

### å¼€å¯è°ƒè¯•æ¨¡å¼

```php
// app/Common/Conf/debug.php
return [
    'SHOW_PAGE_TRACE' => true,
    'SHOW_ERROR_MSG' => true,
    'LOG_RECORD' => true,
    'SQL_DEBUG_LOG' => true,
];
```

### å¸¸ç”¨è°ƒè¯•æ–¹æ³•

```php
// æ‰“å°å˜é‡
dump($var);
print_r($var);
var_dump($var);

// è¾“å‡ºæœ€åæ‰§è¡Œçš„SQL
echo D('User')->getLastSql();

// è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶
\Think\Log::record('è°ƒè¯•ä¿¡æ¯', 'INFO');

// è¿”å›SQLæ‰§è¡Œä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
$ajax = [
    'sql' => D('User')->getLastSql(),
    'data' => $result
];
```

### å¸¸è§é—®é¢˜æ’æŸ¥

```php
// é—®é¢˜ï¼šæ•°æ®æ²¡æœ‰ä¿å­˜
// æ£€æŸ¥éªŒè¯è§„åˆ™
protected $_validate = [
    ['field', 'require', 'æç¤ºä¿¡æ¯']
];

// é—®é¢˜ï¼šSQLæŸ¥è¯¢æ…¢
// æ·»åŠ ç´¢å¼•
// Schema::table('qs_user')->index('email');

// é—®é¢˜ï¼šå†…å­˜æº¢å‡º
// ä½¿ç”¨åˆ†æ‰¹å¤„ç†
$total = D('User')->count();
$batchSize = 100;
for ($i = 0; $i < $total; $i += $batchSize) {
    $list = D('User')->limit($batchSize)->page($i / $batchSize + 1)->select();
    // å¤„ç†æ•°æ®
}
```

---

## References

Detailed guides in `references/`:

### Core Guides

- **[Admin Controllers](references/admin-controllers.md)** - Admin controller guide
  - Standard CRUD pattern
  - Abstract base class pattern
  - Table/Form configuration
  - Knowledge store sync
  - Redis lock usage

- **[API Controllers](references/api-controllers.md)** - API controller guide
  - RestController base class
  - Authentication & authorization
  - Response handling
  - Pagination & filtering
  - Data formatting

- **[CRUD Patterns](references/crud-patterns.md)** - Development patterns
  - Mode selection decision tree
  - Field type configuration
  - Validation rules
  - Business logic encapsulation
  - Performance optimization
  - Concurrency control

- **[Model Guide](references/model-guide.md)** - æ¨¡å‹å¼€å‘æŒ‡å—
  - GyListModel ä»£ç è§„èŒƒ
  - éªŒè¯è§„åˆ™
  - æŸ¥è¯¢æ–¹æ³•å°è£…
  - æ€§èƒ½ä¼˜åŒ–ï¼ˆN+1ã€ç¼“å­˜ï¼‰
  - çŠ¶æ€å˜æ›´é€»è¾‘
  - å®Œæ•´æ¨¡å‹ç¤ºä¾‹

- **[Migration Guide](references/migration-guide.md)** - æ•°æ®åº“è¿ç§»æŒ‡å—
  - è¿ç§»å‘½ä»¤
  - åˆ—ç±»å‹å’Œä¿®é¥°ç¬¦
  - å…ƒæ•°æ®æ³¨é‡Šç³»ç»Ÿ
  - æšä¸¾åˆ—è¡¨
  - ç´¢å¼•è®¾è®¡
  - è¡¨ç»“æ„è§„èŒƒ

- **[Where Query Reference](references/where-query-reference.md)** - æŸ¥è¯¢è¯­æ³•å‚è€ƒ
  - Where æ¡ä»¶è¡¨è¾¾å¼
  - èšåˆæŸ¥è¯¢
  - JOIN å…³è”
  - æ’åºå’Œåˆ†é¡µ

- **[Development Standards](references/development-standards.md)** - Standards & testing
  - PHP 8.2 coding standards
  - React/TypeScript standards
  - Caching & locking
  - Unit testing guide
  - Mock third-party APIs
  - Wall class pattern
  - Code review checklist

### Architecture Patterns

- **[Abstract Base Patterns](references/abstract-base-patterns.md)** - æŠ½è±¡åŸºç±»æ¨¡å¼
  - åˆ†ç±»æ¨¡å—æ¨¡å¼ (ACate/ACateModel)
  - å†…å®¹æ¨¡å—æ¨¡å¼ (AContent/AContentModel)
  - æ ‡ç­¾æ¨¡å—æ¨¡å¼ (ATag/ATagModel)
  - è‡ªå®šä¹‰æ‰©å±•ç­–ç•¥

- **[Migration Metadata](references/migration-metadata.md)** - è¿ç§»æ–‡ä»¶å…ƒæ•°æ®ç³»ç»Ÿ
  - å…ƒæ•°æ®å±æ€§å’Œå­—æ®µç±»å‹æ˜ å°„
  - ä»£ç ç”Ÿæˆè§„åˆ™
  - æšä¸¾åˆ—è¡¨ç³»ç»Ÿ
  - å‘½åè§„èŒƒå’Œæœ€ä½³å®è·µ
